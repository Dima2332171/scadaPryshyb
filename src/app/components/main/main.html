<div class="diagram-container">
  <svg [attr.viewBox]="viewBox" preserveAspectRatio="xMidYMid meet">

    <line x1="50" y1="-240" x2="2050" y2="-240" stroke="var(--color-element)" stroke-width="1"/>

    @for (item of krpz; track item.id) {
      <g [attr.transform]="'translate(' + item.x + ',' + item.y + ')'">
  <!--        <rect width="150" height="250" fill="transparent" rx="5" stroke="var(&#45;&#45;color-element)"></rect>-->

        <text x="75" y="-50" text-anchor="middle" fill="var(--color-element)"
              [attr.font-size]="fontSizePx">
          {{ item.name }}
        </text>
        <circle cx="75" cy="-40" r="4" fill="var(--color-helper)" stroke="var(--color-element)"/>
        <line x1="75" y1="-35" x2="75" y2="0" stroke="var(--color-element)"/>

        @if(item.different === 'option1'){
          <line x1="75" y1="0" x2="75" y2="18" stroke="var(--color-element)"  />
          <g stroke="var(--color-element)" stroke-width="1.5">
            <line x1="70" y1="15" x2="80" y2="25" />
            <line x1="80" y1="15" x2="70" y2="25" />
          </g>

          @if (item.vacuum_switch) {
            <g class="load-switch" (click)="toggleVacuumSwitch(item)">
              <rect x="65" y="25" width="20" height="30" fill="transparent"/>
              <line x1="75" y1="24" x2="75" y2="55" stroke="red" stroke-width="2"/>
            </g>
          }
          @if (!item.vacuum_switch) {
            <g class="load-switch" (click)="toggleVacuumSwitch(item)">
              <rect x="65" y="25" width="20" height="30" fill="transparent"/>
              <line x1="75" y1="24" x2="75" y2="55" stroke="var(--color-helper)" stroke-width="1"/>
              <line x1="65" y1="24" x2="75" y2="55" stroke="green" stroke-width="2"/>
            </g>
          }

          <line x1="75" y1="55" x2="75" y2="235" stroke="var(--color-element)"  />
          <polygon points="75,245  70,235  80,235"
                   fill="transparent"
                   stroke="var(--color-element)"
                   stroke-width="1"
                   stroke-linejoin="round"/>
        }
        @if(item.different === 'option2'){
          <line x1="75" y1="0" x2="75" y2="18" stroke="var(--color-element)"  />
          <g stroke="var(--color-element)" stroke-width="1.5">
            <line x1="70" y1="15" x2="80" y2="25" />
            <line x1="80" y1="15" x2="70" y2="25" />
          </g>
          @if (item.vacuum_switch) {
            <g class="load-switch" (click)="toggleVacuumSwitch(item)">
              <rect x="65" y="25" width="20" height="30" fill="transparent"/>
              <line x1="75" y1="24" x2="75" y2="55" stroke="red" stroke-width="2"/>
            </g>
          }
          @if (!item.vacuum_switch) {
            <g class="load-switch" (click)="toggleVacuumSwitch(item)">
              <rect x="65" y="25" width="20" height="30" fill="transparent"/>
              <line x1="75" y1="24" x2="75" y2="55" stroke="var(--color-helper)" stroke-width="1"/>
              <line x1="65" y1="24" x2="75" y2="55" stroke="green" stroke-width="2"/>
            </g>
          }

          <line x1="75" y1="55" x2="75" y2="155" stroke="var(--color-element)"  />
          <circle cx="75" cy="175" r="20" fill="transparent" stroke="var(--color-element)"/>
          <circle cx="60" cy="200" r="20" fill="transparent" stroke="var(--color-element)"/>
          <circle cx="90" cy="200" r="20" fill="transparent" stroke="var(--color-element)"/>



        }

        @if(!item.different){
          <line x1="75" y1="0" x2="75" y2="18" stroke="var(--color-element)"  />
          <g stroke="var(--color-element)" stroke-width="1.5">
            <line x1="70" y1="15" x2="80" y2="25" />
            <line x1="80" y1="15" x2="70" y2="25" />
          </g>
          @if (item.vacuum_switch) {
            <g class="load-switch" (click)="toggleVacuumSwitch(item)">
              <rect x="65" y="25" width="20" height="30" fill="transparent"/>
              <line x1="75" y1="24" x2="75" y2="55" stroke="red" stroke-width="2"/>
            </g>
          }
          @if (!item.vacuum_switch) {
            <g class="load-switch" (click)="toggleVacuumSwitch(item)">
              <rect x="65" y="25" width="20" height="30" fill="transparent"/>
              <line x1="75" y1="24" x2="75" y2="55" stroke="var(--color-helper)" stroke-width="1"/>
              <line x1="65" y1="24" x2="75" y2="55" stroke="green" stroke-width="2"/>
            </g>
          }

          <g class="satec-krpz" (click)="openView('krpz', item.id)">
            <rect x="10" y="76" width="60" height="50" fill="transparent" />
            <text x="40" y="90" text-anchor="middle" fill="var(--color-element)" [attr.font-size]="fontSizePx">
              {{ getKrpz(item.id)?.satec.p ?? "---" }}
            </text>

            <text x="40" y="115" text-anchor="middle" fill="var(--color-element)" [attr.font-size]="fontSizePx">
              {{ getKrpz(item.id)?.relay_protection.status ?? "---"}}
            </text>
          </g>


          <line x1="75" y1="55" x2="75" y2="235" stroke="var(--color-element)"  />
          <polygon points="75,245  70,235  80,235"
                   fill="transparent"
                   stroke="var(--color-element)"
                   stroke-width="1"
                   stroke-linejoin="round"/>
        }

      </g>
    }

    <!--Лінія, яка з'єднує ІС1 та ІС2-->
    <line x1="1470" y1="90" x2="970" y2="90" stroke="var(--color-element)" stroke-width="1"/>


    @for (item of ktp; track item.id) {
      <g [attr.transform]="'translate(' + item.x + ',' + item.y + ')'">
        <rect width="450" height="550" fill="transparent" rx="5" stroke="var(--color-element)" stroke-dasharray="5,5"></rect>
        <text x="30" y="20" text-anchor="middle" fill="var(--color-element)" font-size="16">
          {{ item.name }}
        </text>
        <circle cx="225" cy="52" r="2" fill="var(--color-element)" stroke="var(--color-element)"/>
        <line x1="215" y1="52" x2="380" y2="52" stroke="var(--color-element)" stroke-width="1"/>
        <circle cx="370" cy="52" r="2" fill="var(--color-element)" stroke="var(--color-element)"/>

        <line x1="370" y1="152" x2="370" y2="52" stroke="var(--color-element)" stroke-width="1"/>
        <polygon points="370,162 365,152 375,152" fill="transparent" stroke="var(--color-element)"/>
        <line x1="370" y1="160" x2="370" y2="170" stroke="var(--color-element)" stroke-width="1"/>
        <line x1="370" y1="170" x2="420" y2="170" stroke="var(--color-element)" stroke-width="1"/>
        <line x1="420" y1="-30" x2="420" y2="170" stroke="var(--color-element)" stroke-width="1"/>

        <line x1="225" y1="82" x2="225" y2="52" stroke="var(--color-element)" stroke-width="1"/>

        <circle cx="225" cy="86" r="3" fill="transparent" stroke="var(--color-element)"/>
        <line x1="218" y1="83" x2="232" y2="83" stroke="var(--color-element)" stroke-width="1"/>
        @if (item.load_switch) {
          <g class="load-switch" (click)="toggleLoadSwitch(item)">
            <rect x="215" y="90" width="20" height="20" fill="transparent"/>
            <line x1="225" y1="90" x2="225" y2="120" stroke="red" stroke-width="2"/>
          </g>
        }
        @if (!item.load_switch) {
          <g class="load-switch" (click)="toggleLoadSwitch(item)">
            <rect x="215" y="90" width="20" height="20" fill="transparent"/>
            <line x1="225" y1="90" x2="225" y2="120" stroke="var(--color-helper)" stroke-width="1"/>
            <line x1="225" y1="120" x2="215" y2="90" stroke="green" stroke-width="2"/>
          </g>
        }


        <!--Лінія від викл нагрузки до трансорматора-->
        <line x1="225" y1="240" x2="225" y2="120" stroke="var(--color-element)" stroke-width="1"/>
        <circle cx="225" cy="140" r="2" fill="var(--color-element)" stroke="var(--color-element)"/>
        <line x1="225" y1="140" x2="205" y2="140" stroke="var(--color-element)" stroke-width="1"/>
        <line x1="205" y1="134" x2="205" y2="146" stroke="var(--color-element)" stroke-width="1"/>

        <g transform="translate(49,-8)">
          @if (item.earthing_switch_1) {
            <g class="earthing-switch" (click)="toggleEarthSwitch1(item)">
              <line x1="155" y1="148" x2="135" y2="148" stroke="red" stroke-width="2"/>
              <rect x="135" y="140" width="20" height="15" fill="transparent" stroke="transparent" stroke-width="1"/>
            </g>
          }
          @if (!item.earthing_switch_1) {
            <g class="earthing-switch" (click)="toggleEarthSwitch1(item)">
              <line x1="155" y1="148" x2="135" y2="148" stroke="var(--color-helper)" stroke-width="2"/>
              <rect x="135" y="140" width="20" height="15" fill="transparent" stroke="transparent" stroke-width="1"/>
              <line x1="155" y1="138" x2="135" y2="148" stroke="green" stroke-width="2"/>
            </g>
          }
          <line x1="135" y1="148" x2="125" y2="148" stroke="var(--color-element)" stroke-width="1"/>
          <line x1="125" y1="140" x2="125" y2="156" stroke="var(--color-element)" stroke-width="1"/>
          <line x1="122" y1="142" x2="122" y2="154" stroke="var(--color-element)" stroke-width="1"/>
          <line x1="119" y1="144" x2="119" y2="152" stroke="var(--color-element)" stroke-width="1"/>
        </g>




        <rect x="218" y="160" width="15" height="30" fill="transparent" stroke="var(--color-element)"
              stroke-width="1.1"/>

        <circle cx="225" cy="210" r="2" fill="var(--color-element)" stroke="var(--color-element)"/>
        <line x1="225" y1="210" x2="205" y2="210" stroke="var(--color-element)" stroke-width="1"/>
        <line x1="205" y1="204" x2="205" y2="216" stroke="var(--color-element)" stroke-width="1"/>

        <g transform="translate(49, 22)">
          @if (item.earthing_switch_2) {
            <g class="earthing-switch" (click)="toggleEarthSwitch2(item)">
              <line x1="155" y1="188" x2="135" y2="188" stroke="red" stroke-width="2"/>
              <rect x="135" y="180" width="20" height="15" fill="transparent" stroke="transparent" stroke-width="1"/>
            </g>
          }
          @if (!item.earthing_switch_2) {
            <g class="earthing-switch" (click)="toggleEarthSwitch2(item)">
              <rect x="135" y="180" width="20" height="15" fill="transparent" stroke="transparent" stroke-width="1"/>
              <line x1="155" y1="178" x2="135" y2="188" stroke="green" stroke-width="2"/>
            </g>
          }
          <line x1="135" y1="188" x2="125" y2="188" stroke="var(--color-element)" stroke-width="1"/>
          <line x1="125" y1="180" x2="125" y2="196" stroke="var(--color-element)" stroke-width="1"/>
          <line x1="122" y1="182" x2="122" y2="194" stroke="var(--color-element)" stroke-width="1"/>
          <line x1="119" y1="184" x2="119" y2="192" stroke="var(--color-element)" stroke-width="1"/>
        </g>




        @for (transformer of item.transformers; track transformer.id) {
          <g [attr.transform]="'translate(' + transformer.x + ',' + transformer.y + ')'">
            <circle cy="4" r="20" fill="transparent" stroke="var(--color-element)"/>
            <circle cy="-20" r="20" fill="transparent" stroke="var(--color-element)"/>
          </g>
        }


        <line x1="225" y1="348" x2="225" y2="302" stroke="var(--color-element)" stroke-width="1"/>
        <line x1="75" y1="348" x2="375" y2="348" stroke="var(--color-element)" stroke-width="1"/>





        <text x="225" y="380" text-anchor="middle" fill="var(--color-element)"
              [attr.font-size]="fontSizePx">
          {{getTotalPowerKtpInverters(getKtp(item.id)?.inverters)}}
        </text>
        @for (inverter of item.inverters; track inverter.id) {

          <g [attr.transform]="'translate(' + (inverter.x) + ',' + (inverter.y) + ')'" (click)="openView('ktp', item.id)">
            <g transform="scale(1.5)">
              <line x1="0" y1="-24" x2="0" y2="-82" stroke="var(--color-element)" stroke-width="1"/>

              <rect x="-24.2" y="-24.2" width="48.4" height="48.4" fill="transparent" stroke="var(--color-element)"
                    stroke-width="1.1"/>
              <line x1="22" y1="-22" x2="-22" y2="22" stroke="var(--color-element)" stroke-width="1.1"/>
              <path d="M-16.5,-8.8 Q-12.1,-12.1 -7.7,-8.8 Q-3.3,-5.5 -2.2,-8.8" fill="none"
                    stroke="var(--color-element)"
                    stroke-width="1.1"/>
              <path d="M-16.5,-3.3 Q-12.1,-6.6 -7.7,-3.3 Q-3.3,0 -2.2,-3.3" fill="none" stroke="var(--color-element)"
                    stroke-width="1.1"/>
<!--              <line x1="7.7,11" x2="14.3,11" stroke="var(&#45;&#45;color-element)" stroke-width="1.1"/>-->
<!--              <line x1="7.7,14.3" x2="14.3,14.3" stroke="var(&#45;&#45;color-element)" stroke-width="1.1"/>-->
              <line x1="0" y1="11" x2="16.5" y2="11" stroke="var(--color-element)" stroke-width="1.1"/>
              <line x1="0" y1="16.5" x2="16.5" y2="16.5" stroke="var(--color-element)" stroke-width="1.1"/>


            </g>
            <text x="0" y="60" text-anchor="middle" fill="var(--color-element)"
                  [attr.font-size]="fontSizePx">
              {{ getInverterKtp(inverter.id)?.a_power }}
            </text>

            <text x="-20" y="-40" text-anchor="middle" fill="var(--color-element)" font-size="18">
              {{ inverter.name }}
            </text>
          </g>
        }

      </g>
    }

    @for (item of mvc; track item.id) {
      <g [attr.transform]="'translate(' + item.x + ',' + item.y + ')'">
        <rect width="450" height="550" fill="transparent" rx="5" stroke="var(--color-element)"></rect>


        @for (inverter of item.inverters; track inverter.id) {
          <g [attr.transform]="'translate(' + inverter.x + ',' + inverter.y + ')'" (click)="openView('mvc-control', inverter.id)">
            <g transform="scale(1.6)">
              <rect x="-22" y="-22" width="44" height="44" fill="transparent" stroke="var(--color-element)"
                    stroke-width="1"/>
              <line x1="20" y1="-20" x2="-20" y2="20" stroke="var(--color-element)" stroke-width="1"/>
              <path d="M-15,-8 Q-11,-11 -7,-8 Q-3,-5 -2,-8" fill="none" stroke="var(--color-element)" stroke-width="1"/>
              <path d="M-15,-3 Q-11,-6 -7,-3 Q-3,0 -2,-3" fill="none" stroke="var(--color-element)" stroke-width="1"/>
<!--              <line x1="7,10" x2="13,10" stroke="var(&#45;&#45;color-element)" stroke-width="1"/>-->
<!--              <line x1="7,13" x2="13,13" stroke="var(&#45;&#45;color-element)" stroke-width="1"/>-->
              <line x1="0" y1="10" x2="15" y2="10" stroke="var(--color-element)" stroke-width="1"/>
              <line x1="0" y1="15" x2="15" y2="15" stroke="var(--color-element)" stroke-width="1"/>


            </g>
            <!--Покази інвертора-->

          </g>


          <line x1="63" y1="370" x2="205" y2="370" stroke="var(--color-element)" stroke-width="1"/>
          <line x1="245" y1="370" x2="390" y2="370" stroke="var(--color-element)" stroke-width="1"/>


        }







        <text x="60" y="20" text-anchor="middle" fill="var(--color-element)">
          {{getMvcGridMode(item.id)}}
        </text>

        <text x="200" y="20" text-anchor="middle" fill="var(--color-element)">
          {{getMvcMode(item.id)}}
        </text>

        <text x="360" y="20" text-anchor="middle" fill="var(--color-element)">
          status: {{getMvcEssStatus(item.id)}}
        </text>

        <text x="220" y="410" text-anchor="middle" fill="var(--color-element)" [attr.font-size]="fontSizePx">
          {{getMvcActivePower(item.id)}} кВт
        </text>

          <text x="220" y="450" text-anchor="middle" fill="var(--color-element)" [attr.font-size]="fontSizePx">
            {{getMvcSoc(item.id)}} %
          </text>


        @for (bess of item.bess; track bess.id) {
          <g [attr.transform]="'translate(' + bess.x + ',' + bess.y + ')'">
            <!--Статус BESS-->
            <line x1="50" y1="-71"  x2="50" y2="0" stroke="var(--color-element)"/>
            <circle cx="92" cy="10" r="3" stroke="green" fill="green"/>
            <rect width="100" height="100" fill="transparent" rx="5" stroke="var(--color-element)"></rect>
            <text x="4" y="16" fill="var(--color-element)" font-size="18">
              {{ bess.id }}
            </text>
          </g>
        }
      </g>
    }


  </svg>
</div>
